<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Excel com Conciliação + Filtro + Totalização</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
table { border-collapse: collapse; margin-bottom: 30px; }
td, th { border: 1px solid #000; padding: 4px; cursor: pointer; }
th { background: #eee; font-weight: bold; }
.selected-column { background-color: #d0f0d0; }

input[type=text] {
    width: 60px;
    padding: 5px;
    margin-right: 10px;
    text-transform: uppercase;
}

#menus {
    display: none;
    margin-top: 15px;
}

#totais {
    margin-top: 10px;
    font-weight: bold;
}
</style>
</head>

<body>

<h2>Ler Excel com Conciliação + Filtro + Totalização</h2>

<input type="file" id="inputExcel" accept=".xlsx,.xls">
<button id="btnLimpar" style="background:#fdd; font-weight:bold;">Limpar Arquivo</button>

<div id="menus">
    <br>
    <!-- Botões de Formatação -->
    <button id="btnDate">Formato Data</button>
    <button id="btnValue">Formato Valor</button>
    <button id="btnOriginal">Original</button>

    <br><br>

    <!-- Colunas -->
    <label>Coluna 1:</label>
    <input type="text" id="col1" maxlength="3">

    <label>Coluna 2:</label>
    <input type="text" id="col2" maxlength="3">

    <label>Resultado:</label>
    <input type="text" id="colR" maxlength="3">

    <button id="btnConciliar" style="background:#cfc; font-weight:bold;">Conciliar</button>

    <br><br>

    <!-- Filtros -->
    <button id="btnConciliados" style="background:#d0ffd0;">Conciliados</button>
    <button id="btnNaoConciliados" style="background:#ffd0d0;">Não Conciliados</button>
    <button id="btnTodos" style="background:#d0d0ff;">Todos</button>

    <button id="btnSalvar" style="background:#ddf; font-weight:bold;">Salvar Tabela</button>

    <div id="totais"></div>
</div>

<div id="output"></div>

<script>
let currentFormat = null;
let originalFileName = "";

// -----------------------------
// Funções originais
// -----------------------------
function columnToLetter(n) {
    let s = "";
    while (n >= 0) {
        s = String.fromCharCode((n % 26) + 65) + s;
        n = Math.floor(n / 26) - 1;
    }
    return s;
}

function letterToColIndex(letter) {
    letter = letter.trim().toUpperCase();
    let col = 0;
    for (let i = 0; i < letter.length; i++) {
        col = col * 26 + (letter.charCodeAt(i) - 64);
    }
    return col - 1;
}

function excelDateToDDMMYYYY(v) {
    if (!isNaN(v) && v > 0 && v < 60000) {
        const base = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(base.getTime() + v * 86400000);
        return `${String(d.getUTCDate()).padStart(2,"0")}/${String(d.getUTCMonth()+1).padStart(2,"0")}/${d.getUTCFullYear()}`;
    }
    return v;
}

function formatValue(v) {
    const num = parseFloat(v);
    return isNaN(num) ? v : num.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});
}

document.getElementById("btnDate").onclick = () => currentFormat = "date";
document.getElementById("btnValue").onclick = () => currentFormat = "value";
document.getElementById("btnOriginal").onclick = () => currentFormat = "original";

// -----------------------------
// LEITURA DO EXCEL
// -----------------------------
document.getElementById("inputExcel").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    originalFileName = file.name.replace(/\.[^/.]+$/, ""); // sem extensão

    const reader = new FileReader();
    reader.onload = function (event) {
        const workbook = XLSX.read(new Uint8Array(event.target.result), { type: "array" });
        let html = "";

        workbook.SheetNames.forEach(name => {
            const sheet = workbook.Sheets[name];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: "" });
            const maxCols = Math.max(...rows.map(r => r.length));

            let table = "<table><tr>";
            for (let c = 0; c < maxCols; c++) {
                table += `<th data-col="${c}">${columnToLetter(c)}</th>`;
            }
            table += "</tr>";

            rows.forEach(row => {
                table += "<tr>";
                for (let c = 0; c < maxCols; c++) {
                    const val = row[c] ?? "";
                    table += `<td data-col="${c}" data-original="${val}">${val}</td>`;
                }
                table += "</tr>";
            });

            table += "</table><hr>";
            html += table;
        });

        document.getElementById("output").innerHTML = html;
        document.getElementById("menus").style.display = "block";

        // Aplicar formatação automática de valor nas colunas 1 e 2
        aplicarFormatoValorAutomatico();

        document.querySelectorAll("td, th").forEach(cell => {
            cell.addEventListener("click", function () {
                if (!currentFormat) return;
                const col = parseInt(this.getAttribute("data-col"));
                const table = this.closest("table");
                const tds = table.querySelectorAll(`td[data-col="${col}"]`);
                tds.forEach(td => {
                    const original = td.getAttribute("data-original");
                    if (currentFormat === "date") td.textContent = excelDateToDDMMYYYY(original);
                    else if (currentFormat === "value") td.textContent = formatValue(original);
                    else td.textContent = original;
                });
                table.querySelectorAll("td, th").forEach(x => x.classList.remove("selected-column"));
                table.querySelectorAll(`[data-col="${col}"]`).forEach(x => x.classList.add("selected-column"));
            });
        });

        atualizarTotais();
    };

    reader.readAsArrayBuffer(file);
});

// -----------------------------
// BOTÃO LIMPAR ARQUIVO
// -----------------------------
document.getElementById("btnLimpar").onclick = () => {
    document.getElementById("output").innerHTML = "";
    document.getElementById("totais").innerHTML = "";
    document.getElementById("menus").style.display = "none";
    document.getElementById("inputExcel").value = "";
    originalFileName = "";
};

// --------------------------------------------------------------
// CONCILIAÇÃO
// --------------------------------------------------------------
document.getElementById("btnConciliar").addEventListener("click", () => {
    const colA = letterToColIndex(document.getElementById("col1").value);
    const colB = letterToColIndex(document.getElementById("col2").value);
    const colR = letterToColIndex(document.getElementById("colR").value);

    document.querySelectorAll("#output table").forEach(table => {
        const rows = table.querySelectorAll("tr");
        let numCols = rows[0].querySelectorAll("th").length;

        if (colR >= numCols) {
            for (let r = 0; r < rows.length; r++) {
                if (r === 0) rows[r].insertAdjacentHTML("beforeend", `<th data-col="${colR}">${columnToLetter(colR)}</th>`);
                else if (r === 1) rows[r].insertAdjacentHTML("beforeend", `<td data-col="${colR}" data-original="Conciliação">Conciliação</td>`);
                else rows[r].insertAdjacentHTML("beforeend", `<td data-col="${colR}" data-original=""></td>`);
            }
        }

        const usadosB = new Set();
        for (let r1 = 2; r1 < rows.length; r1++) {
            const cel1 = rows[r1].querySelector(`td[data-col="${colA}"]`);
            if (!cel1) continue;
            const v1 = cel1.textContent.trim();
            if (!v1) continue;

            for (let r2 = 2; r2 < rows.length; r2++) {
                if (usadosB.has(r2)) continue;
                const cel2 = rows[r2].querySelector(`td[data-col="${colB}"]`);
                if (!cel2) continue;
                const v2 = cel2.textContent.trim();
                if (!v2) continue;

                if (v1 === v2) {
                    usadosB.add(r2);
                    const res1 = rows[r1].querySelector(`td[data-col="${colR}"]`);
                    const res2 = rows[r2].querySelector(`td[data-col="${colR}"]`);
                    res1.textContent = "Sim";
                    res1.setAttribute("data-original","Sim");
                    res2.textContent = "Sim";
                    res2.setAttribute("data-original","Sim");
                    break;
                }
            }
        }
    });

    // Aplicar formatação de valor automaticamente nas colunas 1 e 2
    aplicarFormatoValorAutomatico();

    atualizarTotais();
});

// --------------------------------------------------------------
// FILTRO
// --------------------------------------------------------------
function filtrarTabela(tipo) {
    const colR = letterToColIndex(document.getElementById("colR").value);
    if (colR < 0) return;

    document.querySelectorAll("#output table").forEach(table => {
        const linhas = table.querySelectorAll("tr");
        for (let i = 2; i < linhas.length; i++) {
            const cel = linhas[i].querySelector(`td[data-col="${colR}"]`);
            if (!cel) continue;
            const valor = cel.textContent.trim().toLowerCase();
            if (tipo === "conciliados") linhas[i].style.display = (valor === "sim") ? "" : "none";
            else if (tipo === "nao") linhas[i].style.display = (valor === "") ? "" : "none";
            else linhas[i].style.display = "";
        }
    });

    atualizarTotais();
}

document.getElementById("btnConciliados").onclick = () => filtrarTabela("conciliados");
document.getElementById("btnNaoConciliados").onclick = () => filtrarTabela("nao");
document.getElementById("btnTodos").onclick = () => filtrarTabela("todos");

// --------------------------------------------------------------
// TOTALIZAÇÃO
// --------------------------------------------------------------
function atualizarTotais() {
    const colA = letterToColIndex(document.getElementById("col1").value);
    const colB = letterToColIndex(document.getElementById("col2").value);
    let totalA = 0, totalB = 0;
    const letraA = document.getElementById("col1").value.toUpperCase();
    const letraB = document.getElementById("col2").value.toUpperCase();

    document.querySelectorAll("#output table").forEach(table => {
        const linhas = table.querySelectorAll("tr");
        for (let i = 2; i < linhas.length; i++) {
            if (linhas[i].style.display === "none") continue;
            const celA = linhas[i].querySelector(`td[data-col="${colA}"]`);
            const celB = linhas[i].querySelector(`td[data-col="${colB}"]`);

            if (celA) {
                let txt = celA.textContent.trim().replace(/\./g,"").replace(",",".");
                const n = parseFloat(txt);
                if (!isNaN(n)) totalA += n;
            }
            if (celB) {
                let txt = celB.textContent.trim().replace(/\./g,"").replace(",",".");
                const n = parseFloat(txt);
                if (!isNaN(n)) totalB += n;
            }
        }
    });

    document.getElementById("totais").innerHTML =
        `Total Coluna ${letraB}: ${totalB.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2})} &nbsp;&nbsp; | &nbsp;&nbsp; Total Coluna ${letraA}: ${totalA.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2})}`;
}

// --------------------------------------------------------------
// SALVAR TABELA FILTRADA A PARTIR DA PRIMEIRA LINHA
// --------------------------------------------------------------
document.getElementById("btnSalvar").onclick = () => {
    if (!originalFileName) return;

    const ws_data = [];
    document.querySelectorAll("#output table").forEach(table => {
        const rows = table.querySelectorAll("tr");
        rows.forEach(r => {
            if (r.style.display === "none") return; // ignora linhas filtradas
            const rowData = [];
            r.querySelectorAll("th, td").forEach(cell => rowData.push(cell.textContent));
            ws_data.push(rowData);
        });
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data); // garante que começa da linha 1
    XLSX.utils.book_append_sheet(wb, ws, "Planilha");

    XLSX.writeFile(wb, originalFileName + "_filtrada.xlsx");
};

// --------------------------------------------------------------
// FORMATAÇÃO AUTOMÁTICA DE VALOR NAS COLUNAS 1 E 2
// --------------------------------------------------------------
function aplicarFormatoValorAutomatico() {
    const colA = letterToColIndex(document.getElementById("col1").value);
    const colB = letterToColIndex(document.getElementById("col2").value);
    if (colA < 0 && colB < 0) return;

    document.querySelectorAll("#output table").forEach(table => {
        if (colA >= 0) table.querySelectorAll(`td[data-col="${colA}"]`).forEach(td => td.textContent = formatValue(td.textContent));
        if (colB >= 0) table.querySelectorAll(`td[data-col="${colB}"]`).forEach(td => td.textContent = formatValue(td.textContent));
    });
}
</script>

</body>
</html>
